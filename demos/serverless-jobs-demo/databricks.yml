bundle:
  name: serverless

variables:
  catalog_name:
    type: string
    description: "Unity Catalog catalog name"
    default: ""
  base_volume_path:
    type: string
    description: "UC volume path to synthea landing root"
    default: ""
  env:
    type: string
    description: "Environment: Production, Staging, Dev"
    default: "Production"
  repo_path:
    type: string
    description: "Code path in Databricks workspace"
    default: "/Workspace/Shared/hls-demos/demos/serverless-jobs-demo"
  budget_policy_id:
    type: string
    description: "Serverless budget/usage policy ID for cost tracking"
    default: ""

targets:
  development:
    default: true
    workspace:
      root_path: "/Shared/hls-demos/serverless-jobs-demo"

resources:
  jobs:
    # Classic Compute Jobs
    daily_bronze_ingestion_incr_py_classic:
      name: daily_bronze_ingestion_incr_py_classic
      schedule:
        quartz_cron_expression: "0 0 2 * * ?"
        timezone_id: "UTC"
        pause_status: "PAUSED"
      job_clusters:
        - job_cluster_key: classic_single_node
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            spark_conf:
              spark.databricks.cluster.profile: "singleNode"
              spark.master: "local[*]"
            num_workers: 0
            data_security_mode: "SINGLE_USER"
            runtime_engine: "STANDARD"
            custom_tags:
              ResourceClass: "SingleNode"
      tasks:
        - task_key: bronze_ingest
          job_cluster_key: classic_single_node
          spark_python_task:
            python_file: ${var.repo_path}/src/scripts/bronze/bronze_ingest.py
            source: WORKSPACE
            parameters:
              - --catalog_name
              - ${var.catalog_name}
              - --base_volume_path
              - ${var.base_volume_path}
          libraries: []
          run_if: ALL_SUCCESS
        
        - task_key: bronze_archive
          depends_on:
            - task_key: bronze_ingest
          job_cluster_key: classic_single_node
          spark_python_task:
            python_file: ${var.repo_path}/src/scripts/bronze/bronze_archive.py
            source: WORKSPACE
            parameters:
              - --base_volume_path
              - ${var.base_volume_path}
          libraries: []
          run_if: ALL_SUCCESS
    
    daily_silver_load_incr_py_classic:
      name: daily_silver_load_incr_py_classic
      schedule:
        quartz_cron_expression: "0 30 2 * * ?"
        timezone_id: "UTC"
        pause_status: "PAUSED"
      job_clusters:
        - job_cluster_key: classic_single_node
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            spark_conf:
              spark.databricks.cluster.profile: "singleNode"
              spark.master: "local[*]"
            num_workers: 0
            data_security_mode: "SINGLE_USER"
            runtime_engine: "STANDARD"
            custom_tags:
              ResourceClass: "SingleNode"
      tasks:
        - task_key: load_claims_silver
          job_cluster_key: classic_single_node
          spark_python_task:
            python_file: ${var.repo_path}/src/scripts/silver/load_fact_claims.py
            source: WORKSPACE
            parameters:
              - --catalog_name
              - ${var.catalog_name}
          libraries: []
          run_if: ALL_SUCCESS
        
        - task_key: load_patient_encounters_silver
          job_cluster_key: classic_single_node
          spark_python_task:
            python_file: ${var.repo_path}/src/scripts/silver/load_fact_patient_encounters.py
            source: WORKSPACE
            parameters:
              - --catalog_name
              - ${var.catalog_name}
          libraries: []
          run_if: ALL_SUCCESS
        
        - task_key: load_medications_silver
          job_cluster_key: classic_single_node
          spark_python_task:
            python_file: ${var.repo_path}/src/scripts/silver/load_fact_medications.py
            source: WORKSPACE
            parameters:
              - --catalog_name
              - ${var.catalog_name}
          libraries: []
          run_if: ALL_SUCCESS
        
        - task_key: load_procedures_silver
          job_cluster_key: classic_single_node
          spark_python_task:
            python_file: ${var.repo_path}/src/scripts/silver/load_fact_procedures.py
            source: WORKSPACE
            parameters:
              - --catalog_name
              - ${var.catalog_name}
          libraries: []
          run_if: ALL_SUCCESS
        
        - task_key: load_member_monthly_snapshot_gold
          depends_on:
            - task_key: load_claims_silver
            - task_key: load_patient_encounters_silver
            - task_key: load_medications_silver
            - task_key: load_procedures_silver
          job_cluster_key: classic_single_node
          spark_python_task:
            python_file: ${var.repo_path}/src/scripts/gold/load_fact_member_monthly_snapshot.py
            source: WORKSPACE
            parameters:
              - --catalog_name
              - ${var.catalog_name}
          libraries: []
          run_if: ALL_SUCCESS

    # Serverless Compute Jobs (DAB)
    daily_bronze_ingestion_incr_py_serverless_dab:
      name: daily_bronze_ingestion_incr_py_serverless_dab
      budget_policy_id: ${var.budget_policy_id}
      schedule:
        quartz_cron_expression: 0 0 2 * * ?
        timezone_id: UTC
        pause_status: PAUSED
      tasks:
        - task_key: bronze_ingest
          spark_python_task:
            python_file: ${var.repo_path}/src/scripts/bronze/bronze_ingest.py
            source: WORKSPACE
            parameters:
              - --catalog_name
              - maggiedatabricksterraform_dbw
              - --base_volume_path
              - /Volumes/maggiedatabricksterraform_dbw/synthea/landing
          environment_key: serverless_environment_demo
        - task_key: bronze_archive
          depends_on:
            - task_key: bronze_ingest
          spark_python_task:
            python_file: ${var.repo_path}/src/scripts/bronze/bronze_archive.py
            source: WORKSPACE
            parameters:
              - --base_volume_path
              - /Volumes/maggiedatabricksterraform_dbw/synthea/landing
          environment_key: serverless_environment_demo
      queue:
        enabled: true
      environments:
        - environment_key: serverless_environment_demo
          spec:
            client: "4"
            dependencies:
              - "-r /Volumes/maggiedatabricksterraform_dbw/synthea/admin_configs/requirements.txt"
      performance_target: PERFORMANCE_OPTIMIZED
    
    daily_silver_load_incr_py_serverless_dab:
      name: daily_silver_load_incr_py_serverless_dab
      budget_policy_id: ${var.budget_policy_id}
      schedule:
        quartz_cron_expression: "0 30 2 * * ?"
        timezone_id: "UTC"
        pause_status: "PAUSED"
      tasks:
        - task_key: load_claims_silver
          spark_python_task:
            python_file: ${var.repo_path}/src/scripts/silver/load_fact_claims.py
            source: WORKSPACE
            parameters:
              - --catalog_name
              - ${var.catalog_name}
          libraries: []
          environment_key: serverless_environment_demo
          run_if: ALL_SUCCESS
        
        - task_key: load_patient_encounters_silver
          spark_python_task:
            python_file: ${var.repo_path}/src/scripts/silver/load_fact_patient_encounters.py
            source: WORKSPACE
            parameters:
              - --catalog_name
              - ${var.catalog_name}
          libraries: []
          environment_key: serverless_environment_demo
          run_if: ALL_SUCCESS
        
        - task_key: load_medications_silver
          spark_python_task:
            python_file: ${var.repo_path}/src/scripts/silver/load_fact_medications.py
            source: WORKSPACE
            parameters:
              - --catalog_name
              - ${var.catalog_name}
          libraries: []
          environment_key: serverless_environment_demo
          run_if: ALL_SUCCESS
        
        - task_key: load_procedures_silver
          spark_python_task:
            python_file: ${var.repo_path}/src/scripts/silver/load_fact_procedures.py
            source: WORKSPACE
            parameters:
              - --catalog_name
              - ${var.catalog_name}
          libraries: []
          environment_key: serverless_environment_demo
          run_if: ALL_SUCCESS
        
        - task_key: load_member_monthly_snapshot_gold
          depends_on:
            - task_key: load_claims_silver
            - task_key: load_patient_encounters_silver
            - task_key: load_medications_silver
            - task_key: load_procedures_silver
          spark_python_task:
            python_file: ${var.repo_path}/src/scripts/gold/load_fact_member_monthly_snapshot.py
            source: WORKSPACE
            parameters:
              - --catalog_name
              - ${var.catalog_name}
          libraries: []
          environment_key: serverless_environment_demo
          run_if: ALL_SUCCESS
      queue:
        enabled: true
      environments:
        - environment_key: serverless_environment_demo
          spec:
            client: "4"
            dependencies:
              - "-r /Volumes/maggiedatabricksterraform_dbw/synthea/admin_configs/requirements.txt"
      performance_target: PERFORMANCE_OPTIMIZED

    # Notebook-based Jobs (DAB)
    daily_bronze_ingestion_incr_nb_serverless_dab:
      name: daily_bronze_ingestion_incr_nb_serverless_dab
      budget_policy_id: ${var.budget_policy_id}
      schedule:
        quartz_cron_expression: 0 0 2 * * ?
        timezone_id: UTC
        pause_status: PAUSED
      tasks:
        - task_key: bronze_ingest
          notebook_task:
            notebook_path: ${var.repo_path}/src/notebooks/bronze/bronze_ingest
            source: WORKSPACE
            base_parameters:
              catalog_name: ${var.catalog_name}
              base_volume_path: ${var.base_volume_path}
        - task_key: bronze_archive
          depends_on:
            - task_key: bronze_ingest
          notebook_task:
            notebook_path: ${var.repo_path}/src/notebooks/bronze/bronze_archive
            source: WORKSPACE
            base_parameters:
              catalog_name: ${var.catalog_name}
              base_volume_path: ${var.base_volume_path}
      queue:
        enabled: true
      environments:
        - environment_key: serverless_environment_demo
          spec:
            client: "4"
            dependencies:
              - "-r /Volumes/maggiedatabricksterraform_dbw/synthea/admin_configs/requirements.txt"
      performance_target: PERFORMANCE_OPTIMIZED

    daily_silver_load_incr_nb_serverless_dab:
      name: daily_silver_load_incr_nb_serverless_dab
      budget_policy_id: ${var.budget_policy_id}
      schedule:
        quartz_cron_expression: 0 30 2 * * ?
        timezone_id: UTC
        pause_status: PAUSED
      tasks:
        - task_key: load_claims_silver
          notebook_task:
            notebook_path: ${var.repo_path}/src/notebooks/silver/load_fact_claims
            source: WORKSPACE
            base_parameters:
              catalog_name: ${var.catalog_name}
        - task_key: load_medications_silver
          notebook_task:
            notebook_path: ${var.repo_path}/src/notebooks/silver/load_fact_medications
            source: WORKSPACE
            base_parameters:
              catalog_name: ${var.catalog_name}
        - task_key: load_patient_encounters_silver
          notebook_task:
            notebook_path: ${var.repo_path}/src/notebooks/silver/load_fact_patient_encounters
            source: WORKSPACE
            base_parameters:
              catalog_name: ${var.catalog_name}
        - task_key: load_procedures_silver
          notebook_task:
            notebook_path: ${var.repo_path}/src/notebooks/silver/load_fact_procedures
            source: WORKSPACE
            base_parameters:
              catalog_name: ${var.catalog_name}
        - task_key: load_member_monthly_snapshot_gold
          depends_on:
            - task_key: load_claims_silver
            - task_key: load_medications_silver
            - task_key: load_patient_encounters_silver
            - task_key: load_procedures_silver
          notebook_task:
            notebook_path: ${var.repo_path}/src/notebooks/gold/load_fact_member_monthly_snapshot
            source: WORKSPACE
            base_parameters:
              catalog_name: ${var.catalog_name}
      queue:
        enabled: true
      environments:
        - environment_key: serverless_environment_demo
          spec:
            client: "4"
            dependencies:
              - "-r /Volumes/maggiedatabricksterraform_dbw/synthea/admin_configs/requirements.txt"
      performance_target: PERFORMANCE_OPTIMIZED
